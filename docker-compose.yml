version: '3.9'

# ============================================================================
# BDD100K Complete Docker Compose Configuration
# All services using single unified Dockerfile
# ============================================================================

services:

  # ========================================================================
  # DATA ANALYSIS SERVICE
  # ========================================================================
  analysis:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: bdd100k-analysis
    image: bdd100k:latest
    volumes:
      - ./data:/app/data:ro
      - ./output-Data_Analysis:/app/output-Data_Analysis:rw
    environment:
      - PYTHONUNBUFFERED=1
    command: analysis
    networks:
      - bdd100k-network
    restart: unless-stopped

  # ========================================================================
  # YOLO11 MODEL TRAINING SERVICE
  # ========================================================================
  train-yolo:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: bdd100k-train-yolo
    image: bdd100k:latest
    volumes:
      - ./data:/app/data:ro
      - ./runs-model:/app/runs-model:rw
      - ./configs:/app/configs:ro
    environment:
      - PYTHONUNBUFFERED=1
      - CUDA_VISIBLE_DEVICES=0
    gpus: all
    command: train-yolo
    networks:
      - bdd100k-network
    restart: unless-stopped
    depends_on:
      - analysis

  # ========================================================================
  # INFERENCE SERVICE
  # ========================================================================
  inference:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: bdd100k-inference
    image: bdd100k:latest
    volumes:
      - ./data:/app/data:ro
      - ./runs-model:/app/runs-model:ro
    environment:
      - PYTHONUNBUFFERED=1
      - CUDA_VISIBLE_DEVICES=0
    gpus: all
    command: inference
    networks:
      - bdd100k-network
    restart: unless-stopped
    depends_on:
      - train-yolo

  # ========================================================================
  # EVALUATION SERVICE
  # ========================================================================
  evaluate:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: bdd100k-evaluate
    image: bdd100k:latest
    volumes:
      - ./data:/app/data:ro
      - ./runs-model:/app/runs-model:ro
      - ./output-Data_Analysis:/app/output-Data_Analysis:rw
    environment:
      - PYTHONUNBUFFERED=1
    command: evaluate
    networks:
      - bdd100k-network
    restart: unless-stopped
    depends_on:
      - inference

  # ========================================================================
  # STREAMLIT DASHBOARD SERVICE
  # ========================================================================
  dashboard:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: bdd100k-dashboard
    image: bdd100k:latest
    ports:
      - "8501:8501"
    volumes:
      - ./data:/app/data:ro
      - ./output-Data_Analysis:/app/output-Data_Analysis:ro
      - ./runs-model:/app/runs-model:ro
    environment:
      - PYTHONUNBUFFERED=1
    command: dashboard
    networks:
      - bdd100k-network
    restart: unless-stopped

  # ========================================================================
  # JUPYTER NOTEBOOK SERVICE
  # ========================================================================
  jupyter:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: bdd100k-jupyter
    image: bdd100k:latest
    ports:
      - "8888:8888"
    volumes:
      - ./notebooks:/app/notebooks:rw
      - ./data:/app/data:ro
      - ./runs-model:/app/runs-model:ro
      - ./output-Data_Analysis:/app/output-Data_Analysis:ro
    environment:
      - PYTHONUNBUFFERED=1
    command: jupyter
    networks:
      - bdd100k-network
    restart: unless-stopped

  # ========================================================================
  # TENSORBOARD MONITORING SERVICE
  # ========================================================================
  tensorboard:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: bdd100k-tensorboard
    image: bdd100k:latest
    ports:
      - "6006:6006"
    volumes:
      - ./runs-model:/app/runs-model:ro
    environment:
      - PYTHONUNBUFFERED=1
    command: tensorboard
    networks:
      - bdd100k-network
    restart: unless-stopped

# ============================================================================
# NETWORKS
# ============================================================================
networks:
  bdd100k-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16
